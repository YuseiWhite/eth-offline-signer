# テストカバレッジ

### カバレッジサマリー

**実測値（2025年6月）:**

| 指標 | 実測値 | 目標値 |
|------|--------|--------|
| **全体カバレッジ** | 99.2% | 95%以上 |
| **ブランチカバレッジ** | 95.52% | 90%以上 |
| **関数カバレッジ** | 100% | 95%以上 |
| **総テスト数** | 473テスト | - |

### カバレッジ詳細

#### モジュール別詳細

| モジュール | カバレッジ | ブランチ | 関数 | 説明 |
|------------|------------|----------|------|------|
| **src/index.ts** | 100% | 100% | 100% | エントリーポイント |
| **src/cli/cli.ts** | 98.56% | 97.91% | 100% | CLI制御 |
| **src/core/app.ts** | 100% | 95% | 100% | アプリケーション制御 |
| **src/core/broadcaster.ts** | 100% | 96.55% | 100% | トランザクション送信 |
| **src/core/keyManager.ts** | 98.01% | 88.88% | 100% | 秘密鍵管理 |
| **src/core/networkConfig.ts** | 97.16% | 94.91% | 100% | ネットワーク設定 |
| **src/core/nonceRetry.ts** | 100% | 90% | 100% | Nonce管理 |
| **src/core/signer.ts** | 100% | 100% | 100% | トランザクション署名 |
| **src/core/transactionProcessor.ts** | 100% | 95% | 100% | トランザクション処理 |
| **src/types/schema.ts** | 100% | 100% | 100% | データ検証 |
| **src/utils/errors.ts** | 100% | 100% | 100% | エラー処理 |
| **src/utils/logger.ts** | 100% | 100% | 100% | ログ出力 |

#### Vitest: `pnpm run test:coverage`

```
--------------------------|---------|----------|---------|---------|-------------------
File                      | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
--------------------------|---------|----------|---------|---------|-------------------
All files                 |    99.2 |    95.52 |     100 |    99.2 |
 src                      |     100 |      100 |     100 |     100 |                   
  index.ts                |     100 |      100 |     100 |     100 |                   
 src/cli                  |   98.56 |    97.91 |     100 |   98.56 |
  cli.ts                  |   98.56 |    97.91 |     100 |   98.56 | 215-216
 src/core                 |   98.99 |    93.77 |     100 |   98.99 |
  app.ts                  |     100 |       95 |     100 |     100 | 33                
  broadcaster.ts          |     100 |    96.55 |     100 |     100 | 63                
  keyManager.ts           |   98.01 |    88.88 |     100 |   98.01 | 86-87             
  networkConfig.ts        |   97.16 |    94.91 |     100 |   97.16 | 147-150,417-418   
  nonceRetry.ts           |     100 |       90 |     100 |     100 | 129,171           
  signer.ts               |     100 |      100 |     100 |     100 |                   
  transactionProcessor.ts |     100 |       95 |     100 |     100 | 212
 src/types                |     100 |      100 |     100 |     100 |                   
  schema.ts               |     100 |      100 |     100 |     100 |                   
 src/utils                |     100 |      100 |     100 |     100 |                   
  errors.ts               |     100 |      100 |     100 |     100 |                   
  logger.ts               |     100 |      100 |     100 |     100 |                   
--------------------------|---------|----------|---------|---------|-------------------
```

## 未カバー箇所の技術的制約

以下の未カバー箇所は、技術的制約やエッジケースの性質上、実用的なテストが困難または不適切なものです：

### 1. CLI層 (src/cli/cli.ts)

#### L215-216: Commander.js Exit Override処理
```typescript
handleCliError(new Error(`CLIコマンドエラー: ${err.message}`));
process.exit(1);
```

**制約理由**:
- Commander.jsの内部的なエラーハンドリング機構
- `program.exitOverride()`の戻り値の型定義により、実際のコールバック関数への直接アクセスが制限
- プロセス終了処理のテストは環境に依存し、単体テストでは適切にモックできない

**リスク評価**: 低 - Commander.jsライブラリの標準的な使用パターン

### 2. アプリケーション層 (src/core/)

#### app.ts L33: ブランチカバレッジ
```typescript
if (options.broadcast) {
  // ブロードキャスト処理
} else {
  // オフライン署名のみ - この分岐の特定条件が未カバー
}
```

**制約理由**:
- 条件分岐の組み合わせの一部が、現実的なテストシナリオでは発生しない
- ブランチカバレッジツールの内部計算による報告

**リスク評価**: 無視可能 - 主要なパスは100%カバー済み

#### broadcaster.ts L63: ブランチカバレッジ
```typescript
if (response.status !== 'success') {
  // エラー処理 - 特定のエラー条件が未カバー
}
```

**制約理由**:
- 外部RPCプロバイダーの特定のエラーレスポンス形式に依存
- モックでは再現困難な、実際のネットワーク障害時の特殊なレスポンス

**リスク評価**: 低 - 一般的なエラーケースは十分にテスト済み

#### keyManager.ts L86-87: ZodError以外のエラーハンドリング
```typescript
} catch (error: unknown) {
  if (error instanceof ZodError) {
    // ZodErrorの処理
  }
  throw error; // この行が未カバー
}
```

**制約理由**:
- Zodスキーマの`parse`メソッドが、ZodError以外の例外を投げるケースは極めて稀
- 通常の使用では、バリデーションエラーは必ずZodErrorとして報告される
- 非ZodErrorが発生するのは、メモリ不足やシステム障害などの極端な状況のみ

**リスク評価**: 無視可能 - 実用上発生しないエッジケース

#### networkConfig.ts L147-150: チェーン設定バリデーションエラー
```typescript
if (!result.success) {
  throw new NetworkError(
    `チェーン設定が無効です (Chain ID: ${chainId}): ${result.error.issues[0]?.message}`
  );
}
```

**制約理由**:
- ビルトインのチェーン設定は開発時に検証済み
- 実行時にビルトイン設定が不正になるケースは、コード改変以外では発生しない
- カスタム設定のテストは別の関数でカバー済み

**リスク評価**: 無視可能 - 開発時検証済みの静的設定

#### networkConfig.ts L417-418: getDisplayNetworkInfo例外処理
```typescript
} catch {
  return {
    name: `Unknown Network (${chainId})`,
    explorer: 'N/A',
    type: 'custom',
  };
}
```

**制約理由**:
- `getNetworkConfig`関数の例外をキャッチするフォールバック処理
- 正常なケースでは`getNetworkConfig`が成功するため、例外パスの実行が困難
- UI表示用の安全な代替値を提供する防御的プログラミング

**リスク評価**: 低 - フォールバック処理として適切に機能

#### nonceRetry.ts L129, L171: ブランチカバレッジ
```typescript
// L129: 特定のリトライ条件の組み合わせ
// L171: エラー処理の特定分岐
```

**制約理由**:
- 複雑な条件分岐の特定の組み合わせ
- 実際のネットワーク状況に依存する動的な条件
- タイミングに依存するリトライロジック

**リスク評価**: 低 - 主要なリトライパターンは十分にテスト済み

#### transactionProcessor.ts L212: ブランチカバレッジ
```typescript
// 特定の条件分岐が未カバー
```

**制約理由**:
- 複数の条件の特定の組み合わせ
- 実行時の状態に依存する分岐

**リスク評価**: 低 - 主要な処理パスは100%カバー済み

## テスト戦略

### 重点テスト領域
1. **ビジネスロジック**: 100%カバレッジ達成済み
2. **エラーハンドリング**: 主要なエラーケースを網羅
3. **セキュリティ機能**: 秘密鍵管理、ファイルアクセス制御
4. **ネットワーク通信**: 各種エラー条件とリトライロジック

### 品質保証
- **目標カバレッジ**: 95%以上 → **達成: 99.2%**
- **ブランチカバレッジ**: 90%以上 → **達成: 95.52%**
- **関数カバレッジ**: 95%以上 → **達成: 100%**

### 継続的改善
- 新機能追加時のテストカバレッジ維持
- エッジケースの継続的な識別と文書化
- 実際の運用環境でのエラーパターンの分析と反映
