## ADR 006: Ethereumトランザクション形式の選定

<b>日時: 2025-06-29</b>

### ステータス (Status)
承認済み (accepted)

### 背景 (Context)
このCLIアプリケーションは、Ethereumのオフライン署名済みトランザクションを生成する。Ethereumには複数のトランザクション形式（Legacy, EIP-2930, EIP-1559, EIP-4844等）が存在するため、プロジェクトの要件（学習効果、実装確実性、最新技術への準拠）に最も適した形式を選定する必要があった。特に、gasLimitの柔軟な設定と、現代的なGas経済学への理解を深めることが重視された。

### 決定事項 (Decision)
**EIP-1559 (Type 2) トランザクション形式を実装対象として選定する。**

この形式は、`maxFeePerGas`と`maxPriorityFeePerGas`という動的なガス価格設定を導入しており、現在のEthereumネットワークにおける標準的なトランザクション形式である。この決定により、アプリケーションは現代のEthereumエコシステムとの互換性を確保し、ユーザーに対してより予測可能で効率的なガス料金管理を提供する。

### 比較した選択肢 (Options Considered)

#### 1. Legacy Transaction (Type 0)
- **採用しなかった理由**:
  - **技術的陳腐化**: 現在のEthereumネットワークでは主流ではなく、ガス価格の予測が困難。
  - **学習価値の限界**: 現代的なガス管理（`maxFeePerGas`等）に関する知見が得られない。
  - **非効率性**: ガス価格の急騰時に取引が停滞しやすい。

#### 2. EIP-2930 (Type 1)
- **採用しなかった理由**:
  - 検証の結果、EIP-1559（Type 2）トランザクション形式が`accessList`フィールドをオプションでサポートしており、別途Type 1専用の取扱いを行う必要がない。
  - 単独のType 1エンベロープは、EIP-1559の標準形式に統合されたため、実装とテストの重複が発生し得る。
  - 本プロジェクトでは、Type 2形式での`accessList`利用が可能であり、Type 1を独立して扱うメリットが限定的である。

#### 3. EIP-4844 (Type 3)
- **採用しなかった理由**:
  - **特化しすぎた目的**: レイヤー2のロールアップコストを削減するためのBlobトランザクションであり、レイヤー1での汎用的なトランザクション署名という本プロジェクトの目的と合致しない。
  - **実装の複雑性**: Blobデータの扱いや新しい暗号学的要素（KZGコミットメント）が必要となり、学習スコープを大幅に超える。

#### 4. EIP-1559 (Type 2) - 採用
- **採用理由**:
  - **現代の標準**: 現在のEthereumメインネットで最も広く利用されている形式。
  - **高い学習価値**: `maxFeePerGas`と`maxPriorityFeePerGas`の概念を通じて、現代のガス経済学を深く理解できる。
  - **豊富なツールサポート**: `viem`などの主要ライブラリで完全にサポートされており、実装が確実かつ容易。
  - **要件適合性**: プロジェクトで求められるgasLimitの柔軟な設定に完全に対応している。

### 結果 (Consequences)

#### より簡単になること
- **実装の確実性**: 安定した仕様と`viem`による堅牢なサポートにより、開発がスムーズに進む。
- **テストの容易性**: 豊富なドキュメントとテストケースが存在し、品質保証が容易になる。
- **現代技術の習得**: Ethereumの現在の標準的なトランザクション処理とガス管理の知見を実践的に得られる。
- **デバッグ**: `viem`が提供する明確な型定義とエラーメッセージにより、問題解決が迅速になる。

#### より困難になること
- **後方互換性の欠如**: この決定だけでは、Legacyトランザクション形式しかサポートしない古いツールやシステムとの互換性がない。

ただし、これらの「困難になること」は、プロジェクトのスコープを「現代標準であるEIP-1559単体実装に集中する」と明確に定義することで、意図的に受け入れる制約である。将来的な拡張として、他形式への対応も検討可能だが、本プロジェクトの範囲外とする。