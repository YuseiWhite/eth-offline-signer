## コンテナ仮想化技術の選定

**日時: 2024-06-30**

### ステータス (Status)
承認済み (accepted)

### 背景 (Context)
ローカルでの開発およびテストを安定かつ効率的に行うため、一貫したコンテナ実行環境が必要である。macOS環境における主要な選択肢として、Docker Desktop、OrbStack、そしてAppleネイティブのApple Container(WWDC 2025 発表: 6/9 - 6/13)が存在する。本プロジェクトにとって最適なパフォーマンス、開発者体験、および将来的な拡張性を提供する技術を選定する必要がある。

### 決定事項 (Decision)
**OrbStack**を選定する。

理由は、本プロジェクトが重視する**パフォーマンス**と**クロスプラットフォーム互換性**の要件を最も高いレベルで満たすためである。

1.  **実証されたパフォーマンス**:
    後述する実機テストにおいて、OrbStackはApple Containerに対して全てのタスクで高速であった。特に`test:coverage` (+23.8%)や`lint` (+16.3%)のようなファイルI/Oが多発する処理で明確な優位性を示した。これは開発体験の向上に直接寄与する。

2.  **クロスプラットフォームへの道**:
    Apple ContainerがmacOS専用であるのに対し、OrbStackが準拠するDockerエコシステムはWindows/Linuxでも利用可能である。これにより、将来的に開発者が異なるOSを利用する場合でも、`Dockerfile`や`compose.yml`といった既存資産を再利用でき、プロジェクトのポータビリティが確保される。

3.  **優れた開発者体験**:
    `docker-compose`をそのまま利用できるため、複数コンテナ（`signer-dev`, `anvil`）の連携をコマンド一発で実現できる。これは、手動でのネットワーク設定やコンテナ起動が必要なApple Containerに比べて、開発効率を大幅に向上させる。

### 比較した選択肢 (Options Considered)

#### 1. OrbStack (採用)
- **アーキテクチャ**: macOSに高度に最適化された単一の軽量Linux VM上で、全コンテナを実行する。
- **長所**: パフォーマンスが非常に高く、リソース消費が少ない。Docker CLIおよびComposeとの完全互換性を持つ。
- **短所**: macOS専用。ただし、定義ファイル(`Dockerfile`, `compose.yml`)は他OSのDocker環境でも利用可能。

#### 2. Apple Container (不採用)
- **アーキテクチャ**: コンテナごとに専用の超軽量LinuxマイクロVMを起動する。
- **長所**: 各コンテナが独自のカーネル空間を持つため、分離性とセキュリティが最も高い。
- **短所**: `compose`のようなオーケストレーションツールがなく、複数コンテナの連携が煩雑。パフォーマンス測定でOrbStackに劣る。Appleシリコン搭載macOSに限定される。また、セキュリティに関しては、ベータ版（0.2.0）であるため、プロダクション環境で使用するには適切でない。

#### 3. Docker Desktop for Mac (不採用)
- **アーキテクチャ**: 単一のLinux VM上で動作する業界標準ツール。
- **長所**: 長年の実績と豊富な機能を持つ。
- **短所**: OrbStackと比較して、パフォーマンスやリソース消費で劣ることが多い。

### 結果 (Consequences)

#### ポジティブな結果
- 開発サイクルが高速化される。
- `compose.yml`による環境構築の自動化により、開発者体験が向上する。
- 将来的にWindows/Linux環境へ開発を拡大する際の技術的な障壁が低くなる。

#### ネガティブな結果
- Apple Containerが提供する「コンテナごとのカーネル分離」という最高のセキュリティモデルは採用しない。しかし、開発環境におけるリスクは許容範囲内と判断する。

#### パフォーマンス測定結果詳細 (10回実行平均)

##### Apple Container

| コマンド | 実時間 (real) | ユーザーCPU (user) | システムCPU (sys) |
| :--- | :--- | :--- | :--- |
| **test:coverage** | 9.10s | 17.20s | 3.88s |
| **build** | 6.67s | 9.03s | 1.77s |
| **typecheck** | 7.54s | 10.51s | 1.10s |
| **lint** | 1.14s | 0.99s | 0.23s |
| **check:arch** | 2.62s | 2.53s | 0.44s |

##### OrbStack

| コマンド | 実時間 (real) | ユーザーCPU (user) | システムCPU (sys) |
| :--- | :--- | :--- | :--- |
| **test:coverage** | 7.35s | 15.75s | 3.49s |
| **build** | 6.51s | 8.89s | 1.71s |
| **typecheck** | 7.40s | 10.38s | 1.06s |
| **lint** | 0.98s | 0.86s | 0.20s |
| **check:arch** | 2.41s | 2.40s | 0.39s |

##### 最終比較 (OrbStack基準の遅延率)

| コマンド | 性能差 (%) |
| :--- | :--- |
| **test:coverage** | +23.8% |
| **build** | +2.5% |
| **typecheck** | +1.9% |
| **lint** | +16.3% |
| **check:arch** | +8.7% |
*+はApple Containerの実行時間が長いことを示す。*

## Technical Details

### パフォーマンス測定結果の引用

`local-docs/performance-vm-for-container.md` にて実施した10回実行の平均実時間比較。

| コマンド | OrbStack (平均) | Apple Container (平均) | 性能差 (%) |
| :--- | :--- | :--- | :--- |
| **test:coverage** | 7.35s | 9.10s | **+23.8%** |
| **build** | 6.51s | 6.67s | **+2.5%** |
| **typecheck** | 7.40s | 7.54s | **+1.9%** |
| **lint** | 0.98s | 1.14s | **+16.3%** |
| **check:arch** | 2.41s | 2.62s | **+8.7%** |

*OrbStackの実行時間を基準とした遅延率。+はApple Containerの実行時間が長いことを示す。*

この結果は、単一の最適化VM（OrbStack）とVM-per-Container（Apple Container）というアーキテクチャの違いから生じるファイルシステムやプロセス起動のオーバーヘッドの差を反映していると考えられる。
