## デュアルパッケージ戦略によるESM/CJS互換性の実現

<b>日時: 2025-06-17</b>

### ステータス (Status)
承認済み (accepted)

### 背景 (Context)
Node.jsエコシステムにおいて、CommonJS（CJS）からES Module（ESM）への移行が進んでいる。プロジェクト初期段階で、モジュールシステムの実装戦略を決定する必要があった。

Cursor Botからのバグ報告により、不適切な`exports`設定が判明した：
```json
"exports": {
  ".": {
    "require": "./dist/index.cjs",
    "import": "./dist/index.cjs"
  }
}
```

この設定では、ESMコンシューマーが`import`文を使用した際にCJSファイルが提供され、モジュール解決エラーが発生する問題があった。

### 決定事項 (Decision)
デュアルパッケージ戦略を採用し、CJSとESMの両方を提供する。

#### 実装内容
1. **tsup設定による並列ビルド**
   - CJS: `./dist/index.cjs`
   - ESM: `./dist/index.mjs`
   - CLI: `./dist/cli.cjs`（CJSのみ）

2. **適切なexports設定**: `package.json`

3. **型定義の統合**
   - CJSビルドで`.d.ts`生成
   - ESMビルドでは型定義重複を回避

### 比較した選択肢 (Options Considered)

**Option 1: CJSのみ維持（当初の判断）**
- **メリット**:
  - シンプルな設定、軽量
  - CLIツールの性質に適合（ESMの恩恵が限定的）
  - Node.js環境での十分な機能性
  - 依存関係（commander, viem, zod）がCJSで正常動作
  - 技術負債回避（既存設定が問題なく動作）
- **デメリット**: ESMコンシューマーでの互換性問題、将来性の欠如
- **判定**: 却下（Cursor Botが指摘したバグが発生）

**Option 2: ESMのみ**
- **メリット**:
  - モダンな標準（JavaScriptの標準モジュールシステム）
  - Tree Shaking対応（効率的な未使用コード除去）
  - 静的解析の向上（型推論とバンドル最適化）
  - 将来性（Node.js生態系の方向性）
- **デメリット**:
  - 古いCJSツールとの互換性問題
  - 一部のツールやライブラリでの問題
  - 移行コストと複雑性の増加
- **判定**: 却下（既存CJS環境での問題発生リスク）

**Option 3: デュアルパッケージ（採用）**
- **メリット**:
  - 完全な互換性（CJS/ESM両対応）
  - 将来性とモダン標準への対応
  - Node.jsモジュール解決の標準準拠
  - パッケージAPIの適切なカプセル化
- **デメリット**:
  - デュアルパッケージメンテナンスの複雑性増加
  - ビルド時間とパッケージサイズの増加
  - tsup設定の複雑化
- **判定**: 採用（バグ修正と互換性確保の必要性）

**Option 4: exports未使用**
- **メリット**: 最小設定
- **デメリット**: カプセル化なし、内部ファイルアクセス可能
- **判定**: 却下（セキュリティとAPI設計の観点で不適切）

### 結果 (Consequences)

**より簡単になること:**
- ESM/CJSどちらの環境からでも正常に利用可能
- Node.jsモジュール解決エラーの解消
- ESMコンシューマーとの互換性確保
- パッケージAPIの適切なカプセル化

**より困難になること:**
- ビルド時間の増加（CJS + ESM並列ビルド）
- 配布パッケージサイズの増加
- tsup設定の複雑化

**技術負債回避策:**
- 型定義の重複生成を回避
- CLI部分はCJSのみに限定してサイズを最小化
- 外部依存関係の適切な分離設定