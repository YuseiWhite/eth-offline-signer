# 要件定義書: eth-offline-signer (v1.1.0)

## 1. プロジェクト概要
### 1.1. プロジェクト名
`eth-offline-signer`

### 1.2. 目的・背景
コーディングテストの要件として、秘密鍵をオンラインに晒すことなく安全なオフライン環境でEthereumの署名済みトランザクションを生成し、さらにオプションとしてそのトランザクションをネットワークにブロードキャストし、マイニング完了まで追跡する堅牢なCLIアプリケーションを開発する。

### 1.3. ターゲットユーザー
CLI操作とEthereumの基本的なトランザクション構造を理解しており、指定された入力に対して期待される出力が得られるかを検証できるエンジニア。

### 1.4. スコープ
本書に記載された機能要件・非機能要件の実装のみを対象とする。過剰設計を避け、定義された要件の品質を最大化するため、将来的な機能拡張は一切考慮しない。

## 2. 機能要件
### 2.1. CLIインターフェース
- **コマンド構造:** `eth-offline-signer sign --key-file <path> --params <path> [--broadcast] [--rpc-url <url>]`
- **ヘルプ表示:** `--help` または `-h`
- **バージョン表示:** `--version` または `-v`

### 2.2. 秘密鍵入力
以下のいずれかの方法で秘密鍵を受け付ける。両方が指定された場合はエラーとする。
- **ファイル:** `--key-file`引数でパスを指定。セキュリティ要件として、当該ファイルのパーミッションが`400`でない場合、警告メッセージを標準エラー出力に表示した上で処理を続行する。

### 2.3. トランザクションパラメータ入力
`--params`引数でJSONファイルのパスを指定する。スキーマは以下に厳格に従うこと。
```json
{
  "to": "string",
  "value": "string",
  "chainId": "number",
  "nonce": "number",
  "gasLimit": "string",
  "maxFeePerGas": "string",
  "maxPriorityFeePerGas": "string",
  "accessList": "object[] | undefined"
}
```
*`gasPrice`, `maxFeePerBlobGas`, `blobVersionedHashes` など、EIP-1559以外のトランザクション種別に関連するフィールドはスキーマに含まれない。*

### 2.3.1. nonceの取得方法
オフライン署名においてnonceは必須パラメータとなるため、事前にオンライン環境で以下の方法により取得する必要がある：

**取得手段**:
1. Etherscanなどのブロックエクスプローラーで対象アドレスのTransaction Count確認
2. `eth_getTransactionCount` RPC呼び出し（例: Infura、Alchemy経由）
3. MetaMaskなどのウォレットでAdvanced設定からnonce確認
4. viemクライアントでのpublicClient.getTransactionCount()呼び出し

**注意事項**:
- nonceは対象アドレスの**次回送信予定のトランザクション番号**
- 保留中トランザクションがある場合は最新のnonce + 1を使用
- 不正なnonceは「nonce too low」「nonce too high」エラーの原因となるが、本ツールはブロードキャスト時に自動リトライを試みる。

### 2.4. 対応トランザクション種別
**実装対象: EIP-1559 (Type 2) トランザクション**

#### 技術選定根拠
以下5つのトランザクション種別を全面的に比較検討した結果、EIP-1559を選択：

| 種別 | 技術的特徴 | プロジェクト適合性 | 選定判定 |
|------|-----------|-----------------|----------|
| **Legacy (Type 0)** | gasPrice固定、最基本 | △ 学習価値限定的 | **却下** |
| **EIP-2930 (Type 1)** | accessList追加、gasPrice固定 | △ 過渡期技術 | **却下** |
| **EIP-1559 (Type 2)** | 動的ガス価格、現在標準 | ◎ 最適バランス | **✅採用** |
| **EIP-4844 (Type 3)** | Blob特化、Layer2用 | △ 過剰機能 | **却下** |
| **EIP-7702 (Type 4)** | EOA拡張、未実装 | × 実装困難 | **却下** |

#### EIP-1559選択の決定的理由

**1. 評価基準への最適対応**
- **可読性・保守性**: 標準的仕様、豊富なドキュメント
- **言語・ライブラリ理解度**: viemライブラリでの完全サポート
- **完成度**: 確立された実装パターン、安定したツールチェーン
- **テスト**: 豊富なテストケース、確実なTestnet検証
- **暗号資産理解度**: 現代ガス経済学、baseFee燃焼メカニズム

**2. 他EIPに対する技術的優位性**
```typescript
// EIP-1559の技術的優位性
+ 動的ガス価格メカニズム（baseFee + priorityFee）
+ 予測可能なトランザクション料金
+ ETHのburnによる経済価値固定
+ accessListサポート（EIP-2930包含）
+ Ethereum標準（London Hard Fork以降）
+ 豊富な実装例とツールサポート
```

**3. プロジェクト成功確実性**
- ✅ **Testnet検証**: 主要Testnetでの確実な動作保証
- ✅ **実装複雑度**: 適切なレベル（過小でも過大でもない）
- ✅ **学習価値**: 現代Ethereumの核心技術習得
- ✅ **実用性**: 実際のDAppsで広く使用される形式

#### 実装スコープ
- **必須フィールド**: `maxFeePerGas`, `maxPriorityFeePerGas`, `gasLimit`, `nonce`
- **対応機能**: EIP-2930 accessListサポート
- **除外対象**: 他のトランザクション種別（Legacy, EIP-2930, EIP-4844, EIP-7702）

### 2.5. 署名およびブロードキャストプロセス
- **署名プロセス:** `viem`ライブラリを使用し、いかなる外部ネットワークAPIコールも行わず、完全にオフラインでトランザクション署名を完結させる。
- **ブロードキャストプロセス:** オプションで、署名済みトランザクションを指定されたRPCエンドポイントに送信する。Nonce競合が発生した場合は自動でリトライし、トランザクションがブロックに取り込まれるまで待機する。

### 2.6. 出力
- **オフライン署名時:** 成功時、署名済みの生トランザクションデータ（0xから始まる16進数文字列）を標準出力にのみ出力する。
- **ブロードキャスト時:** トランザクションのブロードキャストとマイニングの各ステップで進捗情報を表示し、最終的にトランザクションハッシュ、エクスプローラーURL、ブロック番号、ガス使用量などの結果を出力する。

### 2.7. エラーハンドリング
失敗時、標準エラー出力に具体的なエラーメッセージを出力し、終了コード1でプロセスを終了する。

## 3. 非機能要件
### 3.1. パフォーマンス
目標実行時間: コマンド実行から出力（またはエラー）まで1秒以内（ネットワーク通信時間を除く）。

### 3.2. セキュリティ
- **依存関係:** `pnpm audit`でhigh以上の脆弱性が検出された場合、CIは失敗する。`dependency-cruiser`を導入し、意図しない依存関係をCIでブロックする。
- **秘密鍵:** メモリ上の秘密鍵は署名完了後、直ちに参照を破棄すること。

### 3.3. 保守性
- **規約:** `Biome`を導入し、CIでコードフォーマットとlint違反がないことを強制する。
- **命名規則:** camelCaseを基本とする。

### 3.4. テスト
- **フレームワーク:** Vitestを使用する。
- **カバレッジ目標値:** 95%以上。
- **結合テスト:** CLIの入出力パターンを網羅するテストを最低5ケース実装する。

### 4. 技術スタック
- **Ethereumライブラリ:** viem (TypeScriptネイティブ、軽量、高性能)
- **CLIフレームワーク:** commander.js (シンプル、実績豊富)
- **入力検証:** zod (堅牢な型安全性を実現)
- **テストフレームワーク:** Vitest (esbuildベースで高速)
- **ビルドプロセス:** tsup (esbuildベースで設定が簡潔)
- **リンター/フォーマッター:** Biome (高速な統合ツールチェーン)

### 5. 成果物と検証方法

#### 5.1. Testnet検証要件
- **対象テストネット:** Hoodi, Sepolia, Anvilなど
- **検証内容:**
  1. EIP-1559トランザクションの署名済み生成
  2. テストネットでのブロードキャスト成功
  3. ブロックエクスプローラーでの取り込み確認
  4. 最低3種類のトランザクションパターンでの検証:
     - 基本ETH送金（accessListなし）
     - ETH送金（accessListあり）
     - 高gasLimitトランザクション（コントラクト呼び出し想定）

#### 5.2. 開発・提出要件
- **リポジトリ:** main/developブランチ運用（Git-flow準拠）
- **コミット規約:** Conventional Commits厳守
- **ドキュメント:** README.mdに以下を必須で含める:
  - プロジェクト概要とEIP-1559選択理由
  - インストール手順（Node.js要件、依存関係）
  - 使用方法（コマンド例、パラメータファイル例、ブロードキャスト方法）
  - gasLimit設定ガイドライン（ETH送金: 21000、ERC-20: 65000-80000等）
  - nonceの取得方法と設定注意事項
  - Testnet検証手順
  - 開発・ビルド手順（npm scripts）
  - セキュリティ考慮事項（秘密鍵管理、オフライン実行推奨）
- **最終提出物:**
  - GitリポジトリURL
  - 主要Testnet上での署名済みTxブロードキャスト成功を示すブロックエクスプローラーURL（最低3件）

**[タスク] 詳細設計書の作成**
上記の要件定義書を100%満たすための、以下の項目を含む詳細設計書をマークダウン形式で作成してください。

1.  **アーキテクチャ設計:** レイヤー構造、依存関係のルール、設計原則を定義してください。
2.  **ディレクトリ構造:** プロジェクトの最適なディレクトリ構造をツリー形式で提案してください。
3.  **CLIコマンド実装 (`commander.js`):** `src/cli/cli.ts`における`sign`コマンドの具体的な実装方法、引数と環境変数の読み取り、ロジックフローを記述してください。
4.  **入力バリデーション (`zod`):** `src/types/schema.ts`に配置する、トランザクションパラメータを検証する`zod`スキーマをコードで記述してください。
5.  **秘密鍵管理:** `src/core/keyManager.ts`に配置する、秘密鍵を安全に読み込む関数のシグネチャと処理概要（パーミッションチェックロジックを含む）を設計してください。
6.  **トランザクション処理フロー:** `src/core/transactionProcessor.ts`を中心とした、署名、ブロードキャスト、Nonceリトライ、レシート待機を含む一連の処理フローを設計してください。
7.  **オフライン署名コアロジック (`viem`):** `src/core/signer.ts`に配置する署名関数のインターフェースと処理フローを設計してください。
8.  **ブロードキャストとNonce管理:** `src/core/broadcaster.ts` と `src/core/nonceRetry.ts` の役割と実装方針を設計してください。
9.  **テスト戦略 (`Vitest`):** 単体テストと結合テストの具体的なテストケースをリストアップし、`vi.mock`や`execa`を用いたテストコードの雛形を提案してください。
10. **エラーハンドリング戦略:** `src/utils/errors.ts`に配置するカスタムエラークラスの設計と、CLI全体でのエラー処理戦略を提案してください。
